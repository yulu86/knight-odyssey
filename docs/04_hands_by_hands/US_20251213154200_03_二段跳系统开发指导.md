# 二段跳系统手把手开发指导

## 文档信息
- **Story ID**: US_20251213154200_03
- **功能名称**: 二段跳系统
- **开发时间**: 1.5人日
- **创建日期**: 2025-12-14

## 一、开发前准备

### 1.1 确认依赖
- [x] 基础跳跃机制（已完成）
- [x] 玩家状态机架构（已完成）
- [x] 物理系统（已完成）

### 1.2 理解需求
- 允许玩家在空中进行第二次跳跃
- 二段跳高度150像素（velocity = -450）
- 每次落地后重置跳跃次数
- 需要独特动画和粒子特效

## 二、开发步骤

### 步骤1：修改Player类，添加跳跃计数管理

**操作文件**: `scripts/characters/player.gd`

**需要添加的代码框架**：
```gdscript
# 在Player类的属性区域添加
var jump_count: int = 0          # 当前跳跃次数
var max_jump_count: int = 2      # 最大跳跃次数

# 在_physics_process方法中添加落地检测
# 注意：找到现有的is_on_floor()检测逻辑，在其后添加
func _physics_process(delta: float) -> void:
    # 现有代码...

    # 新增：落地时重置跳跃计数
    if is_on_floor() and jump_count > 0:
        jump_count = 0
```

**执行说明**：
1. 打开 `scripts/characters/player.gd` 文件
2. 在类的属性声明区域（@export变量附近）添加jump_count相关变量
3. 找到_physics_process方法，在合适位置添加落地重置逻辑
4. 确保不影响现有的移动和跳跃逻辑

### 步骤2：扩展PlayerStateMachine状态枚举

**操作文件**: `scripts/characters/player_state_machine.gd`

**需要修改的代码框架**：
```gdscript
# 找到State枚举定义，添加DOUBLE_JUMP状态
enum State {
    IDLE,
    WALK,
    JUMP,
    FALL,
    DOUBLE_JUMP  # 新增：二段跳状态
}
```

**执行说明**：
1. 打开 `scripts/characters/player_state_machine.gd` 文件
2. 找到State枚举定义
3. 在末尾添加DOUBLE_JUMP状态
4. 保持枚举值的连续性

### 步骤3：创建DoubleJumpState类

**操作文件**: `scripts/characters/states/double_jump_state.gd`（新建文件）

**文件内容框架**：
```gdscript
class_name DoubleJumpState
extends PlayerState

# 状态进入时调用
func enter() -> void:
    super.enter()
    # TODO: 设置二段跳垂直速度为-450
    # TODO: 增加跳跃计数
    # TODO: 播放二段跳动画
    # TODO: 触发粒子特效

# 每帧更新逻辑（处理输入）
func update(delta: float) -> void:
    # TODO: 处理左右移动输入
    # TODO: 检查是否需要转换到FALL状态

# 物理更新（移动和碰撞）
func physics_process(delta: float) -> void:
    # TODO: 调用move_and_slide()
```

**执行说明**：
1. 在 `scripts/characters/states/` 目录下创建新文件 `double_jump_state.gd`
2. 复制上述框架到文件中
3. 后续步骤会完善TODO部分

### 步骤4：在PlayerStateFactory中注册DoubleJumpState

**操作文件**: `scripts/characters/player_state_factory.gd`

**需要修改的代码框架**：
```gdscript
# 在_create_states方法中添加
func _create_states() -> void:
    # 现有的状态创建代码...

    # TODO: 添加DoubleJumpState创建
    # states[State.DOUBLE_JUMP] = DoubleJumpState.new()
```

**执行说明**：
1. 打开 `scripts/characters/player_state_factory.gd` 文件
2. 找到_create_states方法
3. 在现有状态注册代码后添加DoubleJumpState的创建代码
4. 确保state字典正确映射

### 步骤5：修改JumpState支持二段跳检测

**操作文件**: `scripts/characters/states/jump_state.gd`

**需要修改的代码框架**：
```gdscript
# 在update方法中添加二段跳检测
func update(delta: float) -> void:
    # 现有代码...

    # TODO: 添加二段跳输入检测
    # 如果按下跳跃键且跳跃次数未达上限
    # 则转换为DOUBLE_JUMP状态
```

**执行说明**：
1. 打开 `scripts/characters/states/jump_state.gd` 文件
2. 找到update方法
3. 在现有输入处理逻辑后添加二段跳检测
4. 使用state_machine.change_state()进行状态转换

### 步骤6：修改FallState支持二段跳检测

**操作文件**: `scripts/characters/states/fall_state.gd`

**需要修改的代码框架**：
```gdscript
# 在update方法中添加二段跳检测
func update(delta: float) -> void:
    # 现有代码...

    # TODO: 添加二段跳输入检测
    # 如果按下跳跃键且跳跃次数未达上限
    # 则转换为DOUBLE_JUMP状态
```

**执行说明**：
1. 打开 `scripts/characters/states/fall_state.gd` 文件
2. 找到update方法
3. 在现有输入处理逻辑后添加二段跳检测
4. 逻辑与JumpState中的检测相同

### 步骤7：完善DoubleJumpState实现

**操作文件**: `scripts/characters/states/double_jump_state.gd`

**需要完善的代码**：
```gdscript
func enter() -> void:
    super.enter()
    # 设置二段跳垂直速度
    player.velocity.y = -450
    # 增加跳跃计数
    player.jump_count += 1
    # 播放二段跳动画（需后续在AnimationPlayer中创建）
    player.animation_player.play("double_jump")
    # 触发粒子特效（需后续在场景中添加节点）
    if player.has_node("DoubleJumpParticles"):
        player.get_node("DoubleJumpParticles").emitting = true

func update(delta: float) -> void:
    # 处理左右移动输入
    var input_direction = Input.get_axis("move_left", "move_right")
    player.velocity.x = input_direction * player.move_speed

    # 检查状态转换：当开始下落时转换到FALL状态
    if player.velocity.y >= 0:
        state_machine.change_state(State.FALL)

func physics_process(delta: float) -> void:
    player.move_and_slide()
```

**执行说明**：
1. 回到 `double_jump_state.gd` 文件
2. 完善enter、update和physics_process方法
3. 添加必要的错误检查（如节点是否存在）

### 步骤8：配置Player场景的粒子特效节点

**重要提醒**：<font color="red">以下操作需要在Godot编辑器中手动完成，AI无法直接修改场景文件</font>

**操作步骤**：
1. 在Godot编辑器中打开 `scenes/characters/player.tscn`
2. 在Player节点下添加新的子节点
3. 节点类型选择：`GPUParticles2D`
4. 节点命名为：`DoubleJumpParticles`
5. 配置粒子属性：
   - 设置适当的粒子材质
   - 调整发射方向为向上
   - 设置生命周期约0.5秒
   - 配置颜色和大小

### 步骤9：创建二段跳动画

**重要提醒**：<font color="red">以下操作需要在Godot编辑器中手动完成</font>

**操作步骤**：
1. 在Player场景中选择AnimationPlayer节点
2. 创建新动画，命名为"double_jump"
3. 基于现有的jump动画进行修改
4. 可以添加独特的姿势变化，如：
   - 腿部伸展更明显
   - 添加旋转效果
   - 调整动画时长

### 步骤10：测试验证

**测试场景**：`scenes/test/test.tscn`

**测试步骤**：
1. 运行测试场景
2. 执行以下操作验证功能：
   - 按跳跃键（第一次跳跃）
   - 在空中再次按跳跃键（触发二段跳）
   - 验证二段跳高度是否正确
   - 验证落地后跳跃次数是否重置
   - 验证二段跳时的动画效果
   - 验证二段跳时的粒子特效
   - 验证二段跳过程中是否可以左右移动

**预期结果**：
- 可以进行二段跳
- 二段跳高度约为150像素
- 落地后可以再次进行二段跳
- 有独特的动画和特效
- 空中可以自由移动

## 三、注意事项

### 3.1 性能优化
- 粒子特效不要过于复杂
- 确保动画播放流畅
- 避免在_physics_process中创建新对象

### 3.2 调试技巧
- 可以添加print语句输出jump_count值
- 使用Godot调试器监控状态转换
- 检查粒子特效是否正常触发

### 3.3 可能的问题
1. **二段跳无法触发**：检查jump_count管理逻辑
2. **动画不播放**：确认AnimationPlayer中是否创建了double_jump动画
3. **粒子特效不显示**：检查GPUParticles2D节点配置和emitting设置
4. **状态转换异常**：确认状态机中正确注册了DOUBLE_JUMP状态

## 四、完成标准

完成以下所有项目视为开发完成：

- [ ] Player类正确管理jump_count
- [ ] PlayerStateMachine添加了DOUBLE_JUMP状态
- [ ] PlayerStateFactory注册了DoubleJumpState
- [ ] JumpState和FallState支持二段跳检测
- [ ] DoubleJumpState完整实现所有逻辑
- [ ] Player场景配置了粒子特效节点
- [ ] AnimationPlayer创建了double_jump动画
- [ ] 测试验证所有功能正常工作

## 五、后续优化建议

1. 添加音效支持
2. 优化粒子特效视觉效果
3. 调整二段跳的手感和时间窗口
4. 添加二段跳限制机制（如冷却时间）