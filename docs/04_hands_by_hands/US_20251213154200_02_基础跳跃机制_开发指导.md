# 基础跳跃机制开发指导

## 文档信息
- **Story ID**: US_20251213154200_02
- **功能**: 02_基础跳跃机制
- **开发时间**: 预计1人日
- **更新日期**: 2025-12-13

## 目录
1. [开发环境准备](#1-开发环境准备)
2. [步骤1：配置输入映射](#2-步骤1配置输入映射)
3. [步骤2：扩展Player类](#3-步骤2扩展player类)
4. [步骤3：实现JumpState类](#4-步骤3实现jumpstate类)
5. [步骤4：实现FallState类](#5-步骤4实现fallstate类)
6. [步骤5：更新状态机](#6-步骤5更新状态机)
7. [步骤6：创建动画](#7-步骤6创建动画)
8. [步骤7：测试验证](#8-步骤7测试验证)
9. [验收标准](#9-验收标准)
10. [常见问题](#10-常见问题)

---

## 1. 开发环境准备

### 1.1 确保项目配置正确
- 确认Godot版本为4.5
- 确认场景文件 `scenes/characters/player.tscn` 存在
- 确认基础状态机已实现（IdleState、WalkState）

### 1.2 Git版本管理
在开始开发前，建议创建开发分支来管理代码版本

这样可以通过Git更好地管理代码版本，包括：
- 版本回滚能力
- 分支隔离开发
- 清晰的提交历史
- 无需手动备份文件

---

## 2. 步骤1：配置输入映射

### 2.1 打开项目设置
1. 在Godot编辑器中，点击顶部菜单 `项目` → `项目设置`
2. 切换到 `输入映射` 选项卡

### 2.2 添加jump动作
1. 在顶部的输入框中输入 `jump`，点击 `添加`
2. 在右侧的 `事件` 部分，点击 `+` 号
3. 选择 `物理键` 选项
4. 输入 `空格` 或搜索 `Space`，选择 `Space (物理键码 4194320)`
5. 点击 `确定` 保存设置

### 2.3 保存项目设置
- 关闭项目设置对话框，系统会自动保存
- **注意**：这将更新 `project.godot` 文件，添加 `jump` 输入映射

---

## 3. 步骤2：扩展Player类

### 3.1 修改 scripts/characters/player.gd

#### 需要添加的属性：
```gdscript
# 在现有@export变量后添加
@export var jump_velocity: float = -600.0  # 跳跃初速度
var gravity: float  # 从项目设置获取的重力
var is_jumping: bool = false  # 跳跃状态标志
```

#### 需要修改的方法：
```gdscript
# 修改_ready()方法
func _ready() -> void:
    # 获取Godot默认重力设置
    gravity = ProjectSettings.get_setting("physics/2d/default_gravity")
    # 初始化状态机
    state_machine.init(self)
```

#### 需要添加的方法：
```gdscript
# 应用重力
func apply_gravity(delta: float) -> void:
    if not is_on_floor():
        velocity.y += gravity * delta
        # 限制最大下落速度
        velocity.y = min(velocity.y, gravity * 2)

# 执行跳跃
func jump() -> void:
    if is_on_floor() and not is_jumping:
        velocity.y = jump_velocity
        is_jumping = true

# 检查是否可以跳跃
func can_jump() -> bool:
    return is_on_floor() and not is_jumping

# 重置跳跃状态
func reset_jump_state() -> void:
    is_jumping = false

# 获取跳跃状态
func get_jump_state() -> bool:
    return is_jumping
```

#### 修改_physics_process方法：
```gdscript
# 在现有_process方法的基础上添加重力处理
func _physics_process(delta: float) -> void:
    # 应用重力
    apply_gravity(delta)

    # 如果在地面上且不在跳跃状态，重置跳跃标志
    if is_on_floor() and velocity.y >= 0:
        reset_jump_state()

    # 更新状态机
    state_machine.update(delta)

    # 执行移动
    move_and_slide()
```

---

## 4. 步骤3：实现JumpState类

### 4.1 创建文件 scripts/characters/states/jump_state.gd

#### 类的基本结构：
```gdscript
class_name JumpState
extends PlayerState

# 状态进入
func enter() -> void:
    # 触发跳跃
    player.jump()
    # 播放跳跃动画
    play_animation("jump")

# 状态退出
func exit() -> void:
    # 清理状态相关资源
    pass

# 每帧更新
func update(delta: float) -> void:
    # 处理水平移动
    var input_direction = get_horizontal_movement_direction()
    apply_movement(input_direction, delta)
    update_sprite_facing(input_direction)

    # 检查状态转换
    check_state_transition()

# 输入处理
func handle_input(event: InputEvent) -> void:
    # Jump状态下主要处理移动输入
    pass

# 私有方法 - 检查状态转换
func check_state_transition() -> void:
    # 当垂直速度向下时，转换到FallState
    if player.velocity.y > 0:
        transition_to_state(PlayerStateMachine.State.FALL)
```

---

## 5. 步骤4：实现FallState类

### 5.1 创建文件 scripts/characters/states/fall_state.gd

#### 类的基本结构：
```gdscript
class_name FallState
extends PlayerState

# 状态进入
func enter() -> void:
    # 播放下落动画
    play_animation("fall")

# 状态退出
func exit() -> void:
    # 播放着陆动画（如果有）
    if is_on_ground():
        play_animation("land")

# 每帧更新
func update(delta: float) -> void:
    # 处理水平移动（空中控制）
    var input_direction = get_horizontal_movement_direction()
    apply_movement(input_direction, delta)
    update_sprite_facing(input_direction)

    # 检查着陆
    check_landing()

# 输入处理
func handle_input(event: InputEvent) -> void:
    # Fall状态下主要处理移动输入
    pass

# 私有方法 - 检查着陆
func check_landing() -> void:
    if is_on_ground():
        # 根据水平输入决定转换到Idle还是Walk
        if has_no_horizontal_input():
            transition_to_state(PlayerStateMachine.State.IDLE)
        else:
            transition_to_state(PlayerStateMachine.State.WALK)
```

---

## 6. 步骤6：更新状态机

### 6.1 修改 scripts/characters/player_state_machine.gd

#### 更新状态枚举：
```gdscript
# 在现有枚举中添加新状态
enum State {
    IDLE,
    WALK,
    JUMP,    # 新增
    FALL     # 新增
}
```

### 6.2 修改 scripts/characters/states/player_state_factory.gd

#### 更新状态字典：
```gdscript
# 在现有字典中添加新状态
var states: Dictionary = {
    PlayerStateMachine.State.IDLE: IdleState,
    PlayerStateMachine.State.WALK: WalkState,
    PlayerStateMachine.State.JUMP: JumpState,    # 新增
    PlayerStateMachine.State.FALL: FallState     # 新增
}
```

### 6.3 更新IdleState (scripts/characters/states/idle_state.gd)

#### 添加跳跃触发逻辑：
```gdscript
# 在现有的handle_input方法中添加
func handle_input(event: InputEvent) -> void:
    # 现有的移动处理...

    # 添加跳跃检测
    if event.is_action_pressed("jump") and is_on_ground():
        transition_to_state(PlayerStateMachine.State.JUMP)
```

### 6.4 更新WalkState (scripts/characters/states/walk_state.gd)

#### 添加跳跃触发逻辑：
```gdscript
# 在现有的handle_input方法中添加
func handle_input(event: InputEvent) -> void:
    # 现有的移动处理...

    # 添加跳跃检测
    if event.is_action_pressed("jump") and is_on_ground():
        transition_to_state(PlayerStateMachine.State.JUMP)
```

---

## 7. 步骤7：创建动画

### 7.1 打开Player场景
1. 在Godot编辑器中打开 `scenes/characters/player.tscn`
2. 选择 `AnimationPlayer` 节点

### 7.2 创建jump动画
1. 在AnimationPlayer面板，点击 `动画` → `新建`
2. 命名为 `jump`
3. 设置动画时长：0.4秒
4. 设置动画模式：`循环` → `关闭`
5. 编辑精灵的跳跃姿态（需要美术资源）

### 7.3 创建fall动画
1. 创建新动画，命名为 `fall`
2. 设置动画时长：0.5秒
3. 设置动画模式：`循环` → `开启`
4. 编辑精灵的下落姿态

### 7.4 创建land动画（可选）
1. 创建新动画，命名为 `land`
2. 设置动画时长：0.2秒
3. 设置动画模式：`循环` → `关闭`
4. 编辑精灵的着陆姿态

**注意**：如果暂时没有美术资源，可以使用简单的位置变化来模拟跳跃效果

---

## 8. 步骤8：测试验证

### 8.1 打开测试场景
1. 打开 `scenes/test/test.tscn`
2. 确保场景中有Player实例
3. 添加平台供Player站立和跳跃

### 8.2 功能测试清单

#### 基础跳跃测试
- [ ] 按空格键能够触发跳跃
- [ ] 跳跃高度约200像素
- [ ] 跳跃时间约0.8秒
- [ ] 跳跃时播放jump动画

#### 状态转换测试
- [ ] Idle状态下按空格 → JumpState
- [ ] Walk状态下按空格 → JumpState
- [ ] JumpState速度向下 → FallState
- [ ] FallState着陆 → IdleState（无移动）
- [ ] FallState着陆 → WalkState（有移动）

#### 物理行为测试
- [ ] 空中可以左右移动
- [ ] 空中不能连续跳跃
- [ ] 重力效果自然
- [ ] 落地检测准确

#### 性能测试
- [ ] 帧率稳定在60FPS
- [ ] 跳跃响应延迟<50ms
- [ ] 无内存泄漏

### 8.3 调试技巧

#### 使用print调试
```gdscript
# 在状态转换时添加调试信息
func enter() -> void:
    print("Entering JumpState at velocity: ", player.velocity)
```

#### 使用Godot调试器
1. 在Player节点上添加断点
2. 监控velocity值变化
3. 检查状态机current_state

---

## 9. 验收标准

### 9.1 功能验收
1. ✅ 当我按下空格键时，角色执行跳跃动作
2. ✅ 跳跃高度为200像素，跳跃时间0.8秒
3. ✅ 角色在空中时只能进行左右移动，不能连续跳跃
4. ✅ 角色着地时有适当的着陆动画
5. ✅ 跳跃过程中播放跳跃动画
6. ✅ 角色跳跃时的抛物线轨迹自然流畅

### 9.2 性能验收
- 60FPS流畅运行
- 跳跃响应延迟<50ms
- 无明显bug或异常

### 9.3 代码质量验收
- 代码符合项目规范
- 状态机架构清晰
- 注释完整
- 错误处理完善

---

## 10. 常见问题

### 10.1 跳跃不响应
**问题**：按空格键没有反应
**解决**：
- 检查输入映射是否正确配置
- 确认jump动作已添加到项目设置
- 检查PlayerStateFactory是否注册了JumpState

### 10.2 跳跃高度不正确
**问题**：跳得太高或太低
**解决**：
- 调整jump_velocity值（当前为-600）
- 检查gravity值是否正确获取
- 确认物理处理在_physics_process中

### 10.3 状态转换异常
**问题**：状态机卡在某个状态
**解决**：
- 检查transition_to_state调用
- 确认状态切换条件逻辑
- 添加调试输出跟踪状态变化

### 10.4 动画不播放
**问题**：跳跃时没有动画
**解决**：
- 确认动画已创建
- 检查动画名称是否正确
- 验证AnimationPlayer引用是否正确

---

## 完成后续

完成所有步骤后，请按以下Git工作流提交代码：

```bash
# 检查当前变更状态
git status

# 添加所有相关文件到暂存区
git add scripts/characters/player.gd
git add scripts/characters/player_state_machine.gd
git add scripts/characters/states/jump_state.gd
git add scripts/characters/states/fall_state.gd
git add scripts/characters/states/idle_state.gd
git add scripts/characters/states/walk_state.gd
git add scripts/characters/states/player_state_factory.gd
git add project.godot

# 提交跳跃功能实现
git commit -m "feat: 实现基础跳跃机制

- 添加JumpState和FallState状态类
- 集成Godot默认重力系统(gravity: 980 px/s²)
- 实现跳跃物理参数(jump_velocity: -600, height: 200px)
- 添加跳跃输入映射(jump动作绑定空格键)
- 扩展状态机架构支持跳跃逻辑
- 完成验收标准所有功能点

测试通过：
- 空格键触发跳跃 ✓
- 跳跃高度200像素 ✓
- 跳跃时间0.8秒 ✓
- 空中只允许左右移动 ✓
- 状态转换正常 ✓
- 动画播放正确 ✓

🤖 Generated with Claude Code

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# 切换回主分支
git checkout master

# 合并开发分支
git merge feature/basic-jump-mechanism

# 推送到远程仓库（如果需要）
git push origin master

# 删除开发分支（可选）
git branch -d feature/basic-jump-mechanism
```

### 更新项目文档
别忘了更新backlog.md中的Story状态为"已完成"

祝开发顺利！如有问题，请参考项目文档或联系技术负责人。