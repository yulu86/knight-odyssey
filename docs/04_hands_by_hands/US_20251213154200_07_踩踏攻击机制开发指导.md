# 踩踏攻击机制手把手开发指导

## 前言

本文档将指导您一步步实现踩踏攻击机制。这个功能将允许玩家从高处跳到敌人身上进行踩踏攻击，并在踩踏成功后获得小幅反弹。

## 开发准备

### 必需资源
- 踩踏动画帧（stomp动画）
- 踩踏音效（hurt.wav）
- 敌人被击败音效（explosion.wav）
- 反弹音效（轻微的"嗖"声）

## 步骤1：设置碰撞层

### 1.1 打开项目设置
1. 在Godot编辑器中，打开 `项目 -> 项目设置`
2. 切换到 `层映射 -> 2D物理` 标签页
3. 添加以下层的名称：
   - Layer 1: `player_layer`（已存在）
   - Layer 2: `player_foot_layer`（新增）
   - Layer 3: `enemy_layer`（新增）
   - Layer 4: `enemy_hittable_layer`（新增）

### 1.2 验证设置
确保层的名称已正确显示在项目设置中。

## 步骤2：修改Player场景

### 2.1 打开Player场景
1. 在场景树中打开 `scenes/characters/player.tscn`
2. 选择Player根节点

### 2.2 添加FootArea节点
1. 右键点击Player节点 -> `添加子节点`
2. 选择 `Area2D` 并命名为 `FootArea`
3. 设置FootArea的Transform：
   - Position Y: 30（脚部位置）
   - Scale: (0.8, 0.3)（椭圆形，覆盖脚部区域）

### 2.3 配置FootArea碰撞层
1. 选择FootArea节点
2. 在检查器中找到 `Collision -> Layer`：
   - 取消勾选 Layer 1
   - 勾选 Layer 2 (player_foot_layer)
3. 在 `Collision -> Mask` 中：
   - 只勾选 Layer 4 (enemy_hittable_layer)

### 2.4 添加碰撞形状
1. 右键点击FootArea -> `添加子节点`
2. 选择 `CollisionShape2D`
3. 设置Shape为 `CapsuleShape2D`
4. 调整Radius和Height以匹配脚部区域

### 2.5 连接信号
1. 选择FootArea节点
2. 在检查器中点击 `节点` 标签
3. 双击 `area_entered` 信号
4. 选择连接到Player脚本
5. 保持默认连接方式

## 步骤3：创建StompState脚本

### 3.1 创建脚本文件
1. 在文件系统中导航到 `scripts/characters/states/`
2. 右键 -> `新建 -> Script`
3. 命名为 `stomp_state.gd`
4. 选择继承自 `PlayerState`

### 3.2 编写StompState类框架

```gdscript
class_name StompState
extends PlayerState

# 导出变量
@export var stomp_velocity: float = -120.0
@export var invincible_time: float = 0.5
@export var animation_duration: float = 0.3

# 内部变量
var stomp_timer: float = 0.0
var is_invincible: bool = false

# 进入状态
func enter() -> void:
    # TODO: 实现进入状态逻辑
    pass

# 退出状态
func exit() -> void:
    # TODO: 实现退出状态逻辑
    pass

# 更新逻辑
func update(delta: float) -> void:
    # TODO: 实现更新逻辑
    pass

# 物理更新
func physics_process(delta: float) -> void:
    # TODO: 实现物理更新逻辑
    pass

# 处理输入
func handle_input() -> void:
    # TODO: 实现输入处理
    pass

# 处理脚部碰撞
func _on_foot_area_entered(area: Area2D) -> void:
    # TODO: 实现踩踏检测逻辑
    pass
```

## 步骤4：更新PlayerStateMachine

### 4.1 修改枚举
打开 `scripts/characters/player_state_machine.gd`，在State枚举中添加：

```gdscript
enum State {
    IDLE,
    WALK,
    JUMP,
    FALL,
    STOMP  # 新增
}
```

### 4.2 修改状态映射
在 `state_map` 字典中添加：

```gdscript
@onready var state_map: Dictionary = {
    State.IDLE: idle_state,
    State.WALK: walk_state,
    State.JUMP: jump_state,
    State.FALL: fall_state,
    State.STOMP: stomp_state  # 新增
}
```

### 4.3 添加状态引用
在类顶部添加：

```gdscript
@onready var stomp_state: StompState = $StompState
```

## 步骤5：更新PlayerStateFactory

### 5.1 注册新状态
打开 `scripts/characters/player_state_factory.gd`，在 `register_states()` 方法中添加：

```gdscript
func register_states() -> void:
    register_state(PlayerStateMachine.State.IDLE, idle_state)
    register_state(PlayerStateMachine.State.WALK, walk_state)
    register_state(PlayerStateMachine.State.JUMP, jump_state)
    register_state(PlayerStateMachine.State.FALL, fall_state)
    register_state(PlayerStateMachine.State.STOMP, stomp_state)  # 新增
```

## 步骤6：修改FallState

### 6.1 添加踩踏检测逻辑
在 `scripts/characters/states/fall_state.gd` 中，添加踩踏检测：

```gdscript
# 在类的顶部添加引用
@onready var foot_area: Area2D = player.get_node("FootArea")

# 在enter()方法中连接信号
func enter() -> void:
    super.enter()
    foot_area.area_entered.connect(_on_foot_area_entered)

# 在exit()方法中断开信号
func exit() -> void:
    super.exit()
    foot_area.area_entered.disconnect(_on_foot_area_entered)

# 添加踩踏检测方法
func _on_foot_area_entered(area: Area2D) -> void:
    if area.get_collision_layer() == 4:  # enemy_hittable_layer
        # 过渡到踩踏状态
        state_changed.emit(PlayerStateMachine.State.STOMP)
```

## 步骤7：配置文件设置

### 7.1 更新配置文件
打开 `configs/player_config.cfg`，添加：

```ini
[stomp]
stomp_velocity=-120.0
invincible_time=0.5
animation_duration=0.3
detection_threshold=50.0
```

### 7.2 加载配置
在 `StompState` 的 `enter()` 方法中加载配置：

```gdscript
func enter() -> void:
    super.enter()
    # 从配置文件加载参数
    stomp_velocity = ConfigManager.get_stomp_value("stomp_velocity", -120.0)
    invincible_time = ConfigManager.get_stomp_value("invincible_time", 0.5)
```

## 步骤8：实现StompState细节

### 8.1 完善enter()方法

```gdscript
func enter() -> void:
    super.enter()

    # 从配置文件加载参数
    stomp_velocity = ConfigManager.get_stomp_value("stomp_velocity", -120.0)
    invincible_time = ConfigManager.get_stomp_value("invincible_time", 0.5)
    animation_duration = ConfigManager.get_stomp_value("animation_duration", 0.3)

    # 初始化变量
    stomp_timer = 0.0
    is_invincible = true

    # 播放踩踏动画
    if sprite.sprite_frames.has_animation("stomp"):
        sprite.play("stomp")

    # 设置反弹速度
    player.velocity.y = stomp_velocity

    # 播放音效
    if AudioServer.is_bus_mute(AudioServer.get_bus_index("Master")) == false:
        # 播放踩踏音效
        pass
```

### 8.2 完善update()方法

```gdscript
func update(delta: float) -> void:
    super.update(delta)

    # 更新计时器
    stomp_timer += delta

    # 检查是否应该退出状态
    if stomp_timer >= animation_duration:
        if player.is_on_floor():
            state_changed.emit(PlayerStateMachine.State.IDLE)
        else:
            state_changed.emit(PlayerStateMachine.State.FALL)
```

### 8.3 完善physics_process()方法

```gdscript
func physics_process(delta: float) -> void:
    super.physics_process(delta)

    # 应用重力
    player.velocity.y += gravity * delta

    # 处理水平移动
    var input_direction = Input.get_axis("move_left", "move_right")
    player.velocity.x = move_toward(player.velocity.x, input_direction * move_speed, acceleration * delta)

    # 应用速度
    player.move_and_slide()
```

## 步骤9：测试场景

### 9.1 创建测试场景
1. 打开 `scenes/test/test.tscn`
2. 添加一个静态平台（用于测试踩踏）
3. 添加一个敌人（暂时用一个带Area2D的StaticBody2D模拟）

### 9.2 配置测试敌人
1. 创建一个敌人场景
2. 主节点使用CollisionObject2D，设置在Layer 3
3. 添加一个Area2D作为可踩踏区域，设置在Layer 4
4. 连接相应信号测试

## 步骤10：调试和优化

### 10.1 常见问题检查
- 确保碰撞层设置正确
- 检查Area2D的大小是否合适
- 验证信号是否正确连接
- 确认动画播放正常

### 10.2 性能优化
- 使用信号机制而非每帧检测
- 确保踩踏检测只在下落时触发
- 优化碰撞形状的大小

## 步骤11：添加视觉反馈

### 11.1 敌人被击败效果
```gdscript
# 在敌人脚本中添加
func handle_stomp_attack() -> void:
    # 播放击败动画
    # 播放击败音效
    # 生成特效
    # 销毁敌人对象
    queue_free()
```

### 11.2 玩家无敌视觉提示
```gdscript
# 在Player脚本中添加闪烁效果
func apply_invincibility_effect(duration: float) -> void:
    var tween = create_tween()
    tween.tween_property(sprite, "modulate:a", 0.5, 0.1)
    tween.tween_property(sprite, "modulate:a", 1.0, 0.1)
    tween.set_loops(int(duration / 0.2))
```

## 注意事项

1. **手动操作提醒**：
   - 必须手动编辑 `scenes/characters/player.tscn` 添加FootArea节点
   - 必须手动设置项目中的碰撞层名称
   - 必须手动在 `player.tscn` 中添加StompState节点

2. **测试验证**：
   - 每完成一个步骤都要进行测试
   - 使用 `print()` 语句调试状态转换
   - 检查控制台是否有错误信息

3. **扩展性**：
   - 代码已预留扩展接口
   - 后续可以轻松添加不同类型的踩踏效果
   - 支持可配置的参数调整

## 完成标准

当您完成以下内容时，踩踏攻击机制就算完成了：

1. ✅ 玩家从高处下落时踩踏敌人能够触发踩踏状态
2. ✅ 踩踏成功后玩家能够以-120像素/秒的速度反弹
3. ✅ 踩踏后有0.5秒的无敌时间
4. ✅ 侧面碰撞不会触发踩踏攻击
5. ✅ 所有参数都可通过配置文件调整
6. ✅ 动画和音效正常播放

## 后续扩展

- 添加不同类型敌人的踩踏效果
- 实现踩踏连击系统
- 添加踩踏特效
- 优化踩踏手感参数