# 基础角色移动系统 - TDD开发指导

**更新日期**: 2025-12-21
**Story**: KO_20251216_001 - 基础角色移动系统
**开发者**: 待分配

---

## 一、开发前置准备

### 1.1 创建测试框架
```
在addons/gut目录下创建测试文件结构：
- test/unit/test_player_movement.gd
- test/integration/test_player_input.gd
```

### 1.2 配置GUT测试环境
```
在项目设置中添加GUT配置：
- res://addons/gut/gut_config.gd
```

---

## 二、Task 1: 项目设置和配置管理 (1天)

### 2.1 配置输入映射
**测试先行** (5分钟)：
```gdscript
# test/unit/test_input_config.gd
extends GutTest

func test_input_actions_defined():
    assert_true(InputMap.has_action("move_left"))
    assert_true(InputMap.has_action("move_right"))
    assert_true(InputMap.has_action("jump"))
```

**实现步骤** (55分钟)：
1. 打开 项目设置 > 输入映射
2. 添加动作：
   - "move_left": A键, 左箭头
   - "move_right": D键, 右箭头
   - "jump": 空格键
3. 测试：运行GUT测试确保配置生效

### 2.2 创建配置管理器
**测试先行** (10分钟)：
```gdscript
# test/unit/test_config_manager.gd
extends GutTest

var config_manager: ConfigManager

func before_each():
    config_manager = ConfigManager.new()

func test_load_player_config():
    var config = config_manager.load_player_config()
    assert_eq(config.speed, 200.0)
    assert_eq(config.jump_velocity, -400.0)
```

**实现步骤** (50分钟)：
1. 创建 scripts/managers/config_manager.gd
2. 实现配置加载方法
3. 创建 configs/player.cfg 配置文件
4. 测试：验证配置正确加载

---

## 三、Task 2: 基础角色场景搭建 (0.5天)

### 3.1 创建Player场景
**测试先行** (10分钟)：
```gdscript
# test/unit/test_player_scene.gd
extends GutTest

var player_scene: PackedScene
var player: CharacterBody2D

func before_each():
    player_scene = load("res://scenes/player/player.tscn")
    player = player_scene.instantiate()

func test_player_has_required_nodes():
    assert_not_null(player.get_node("CollisionShape2D"))
    assert_not_null(player.get_node("Sprite2D"))
    assert_not_null(player.get_node("AnimationPlayer"))
```

**实现步骤** (20分钟)：
1. 创建场景：scenes/player/player.tscn
2. 添加节点树结构：
   - CharacterBody2D (根节点)
     - CollisionShape2D (Shape: CapsuleShape2D)
     - Sprite2D (Texture: 临时占位图)
     - AnimationPlayer
3. 保存场景
4. 测试：验证场景结构

---

## 四、Task 3: 状态机框架 (1天)

### 4.1 创建状态基类
**测试先行** (15分钟)：
```gdscript
# test/unit/test_player_state.gd
extends GutTest

class MockState extends PlayerState:
    func enter():
        super.enter()

    func exit():
        super.exit()

    func update(delta):
        return null

func test_state_has_player_reference():
    var player = CharacterBody2D.new()
    var state = MockState.new(player)
    assert_eq(state.player, player)

func test_state_enter_exit_called():
    var player = CharacterBody2D.new()
    var state = MockState.new(player)
    state.enter()
    state.exit()
    assert_true(state.entered)
    assert_true(state.exited)
```

**实现步骤** (45分钟)：
1. 创建 scripts/player/states/player_state.gd 基类
2. 实现enter/exit/update方法
3. 添加状态切换逻辑
4. 测试：验证状态基类功能

### 4.2 创建状态机
**测试先行** (20分钟)：
```gdscript
# test/unit/test_state_machine.gd
extends GutTest

var state_machine: PlayerStateMachine
var player: CharacterBody2D

func before_each():
    player = CharacterBody2D.new()
    state_machine = PlayerStateMachine.new()

func test_state_machine_initialization():
    assert_not_null(state_machine.current_state)
    assert_eq(state_machine.current_state_name, "Idle")

func test_state_transition():
    state_machine.transition_to("Walk")
    assert_eq(state_machine.current_state_name, "Walk")
```

**实现步骤** (40分钟)：
1. 创建 scripts/player/player_state_machine.gd
2. 实现状态注册和切换
3. 添加状态更新循环
4. 测试：验证状态切换逻辑

---

## 五、Task 4: 空闲状态实现 (0.5天)

### 5.1 空闲状态类
**测试先行** (15分钟)：
```gdscript
# test/unit/test_idle_state.gd
extends GutTest

var idle_state: IdleState
var player: CharacterBody2D

func before_each():
    player = CharacterBody2D.new()
    idle_state = IdleState.new(player)

func test_idle_state_no_movement():
    var velocity = idle_state.update(0.016)
    assert_eq(velocity.x, 0.0)
    assert_eq(velocity.y, 0.0)

func test_idle_to_walk_transition():
    Input.action_press("move_right")
    var next_state = idle_state.get_transition()
    assert_eq(next_state, "Walk")
    Input.action_release("move_right")
```

**实现步骤** (15分钟)：
1. 创建 scripts/player/states/idle_state.gd
2. 实现空闲逻辑（无移动输入）
3. 添加状态切换检测
4. 测试：验证空闲状态和转换

---

## 六、Task 5: 行走状态实现 (1天)

### 6.1 行走状态类
**测试先行** (20分钟)：
```gdscript
# test/unit/test_walk_state.gd
extends GutTest

var walk_state: WalkState
var player: CharacterBody2D

func before_each():
    player = CharacterBody2D.new()
    walk_state = WalkState.new(player)

func test_walk_movement_right():
    Input.action_press("move_right")
    var velocity = walk_state.update(0.016)
    assert_true(velocity.x > 0)

func test_walk_movement_left():
    Input.action_press("move_left")
    var velocity = walk_state.update(0.016)
    assert_true(velocity.x < 0)

func test_walk_to_idle_transition():
    Input.action_release("move_right")
    var next_state = walk_state.get_transition()
    assert_eq(next_state, "Idle")
```

**实现步骤** (40分钟)：
1. 创建 scripts/player/states/walk_state.gd
2. 实现左右移动逻辑
3. 添加加速度和摩擦力
4. 测试：验证移动和状态转换

---

## 七、Task 6: 跳跃/下落状态实现 (1.5天)

### 7.1 跳跃状态类
**测试先行** (30分钟)：
```gdscript
# test/unit/test_jump_state.gd
extends GutTest

var jump_state: JumpState
var player: CharacterBody2D

func before_each():
    player = CharacterBody2D.new()
    jump_state = JumpState.new(player)

func test_jump_velocity():
    var velocity = jump_state.update(0.016)
    assert_true(velocity.y < 0)

func test_jump_to_fall_transition():
    jump_state.velocity.y = 100  # 模拟下落
    var next_state = jump_state.get_transition()
    assert_eq(next_state, "Fall")
```

**实现步骤** (90分钟)：
1. 创建 scripts/player/states/jump_state.gd
2. 创建 scripts/player/states/fall_state.gd
3. 实现重力和跳跃物理
4. 添加空中控制
5. 测试：验证跳跃物理和状态切换

---

## 八、Task 7: 动画系统集成 (1天)

### 8.1 动画状态绑定
**测试先行** (20分钟)：
```gdscript
# test/unit/test_animation_binding.gd
extends GutTest

var player: CharacterBody2D
var animation_player: AnimationPlayer

func before_each():
    var scene = load("res://scenes/player/player.tscn").instantiate()
    player = scene
    animation_player = player.get_node("AnimationPlayer")

func test_idle_animation():
    player.state_machine.transition_to("Idle")
    assert_eq(animation_player.current_animation, "idle")
```

**实现步骤** (40分钟)：
1. 创建动画资源（临时方块动画）
2. 在状态中绑定动画播放
3. 实现动画过渡
4. 测试：验证状态和动画同步

---

## 九、Task 8: 测试和优化 (0.5天)

### 9.1 集成测试
**测试内容** (30分钟)：
```gdscript
# test/integration/test_player_movement_system.gd
extends GutTest

func test_full_movement_cycle():
    # 完整的移动循环测试
    # 空闲 -> 行走 -> 跳跃 -> 下落 -> 空闲
```

### 9.2 性能优化
**优化内容** (30分钟)：
1. 检查帧率稳定性
2. 优化状态切换开销
3. 调整物理参数

---

## 十、验收测试清单

在完成开发后，运行以下验收测试：

### 10.1 功能测试
- [ ] A/左箭头键：角色向左移动，播放行走动画
- [ ] D/右箭头键：角色向右移动，播放行走动画
- [ ] 松开移动键：角色逐渐停止，回到空闲状态
- [ ] 空格键：角色跳跃，播放跳跃动画
- [ ] 空中控制：有空中摩擦力，控制精准
- [ ] 落地检测：正确回到空闲或行走状态

### 10.2 性能测试
- [ ] 稳定60FPS
- [ ] 动画切换无延迟
- [ ] 响应延迟<16ms

### 10.3 配置测试
- [ ] 速度参数可通过配置调整
- [ ] 跳跃高度可配置
- [ ] 加速度和摩擦力可调

---

## 十一、常见问题解决

### 11.1 角色移动迟滞
```gdscript
# 检查friction值是否合适
# 建议范围：10-50
```

### 11.2 跳跃手感不佳
```gdscript
# 调整coyote_time和jump_buffer_time
# 优化空中控制加速度
```

### 11.3 动画不同步
```gdscript
# 确保状态切换时正确调用动画
# 使用AnimationPlayer的play()方法
```

---

## 十二、交付物清单

- [ ] scenes/player/player.tscn
- [ ] scripts/player/player_controller.gd
- [ ] scripts/player/player_state_machine.gd
- [ ] scripts/player/states/*.gd
- [ ] scripts/managers/config_manager.gd
- [ ] configs/player.cfg
- [ ] test/unit/test_*.gd
- [ ] test/integration/test_*.gd

---

**开发时间估算**: 6.5天
**测试覆盖率要求**: >90%
**代码质量标准**: 通过GDCS静态分析检查